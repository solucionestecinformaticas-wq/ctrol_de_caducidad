<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Caducidades</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- QuaggaJS for barcode scanning -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    .scrollbar-custom {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    .scrollbar-custom::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-custom::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    .scrollbar-custom::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 10px;
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .fade-enter {
      opacity: 0;
      transform: translateY(-10px);
    }
    .fade-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: all 0.3s ease;
    }
    .fade-exit {
      opacity: 1;
    }
    .fade-exit-active {
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // Database helper
    const useIndexedDB = () => {
      const DB_NAME = 'ExpiryControlDB';
      const DB_VERSION = 1;
      const STORE_NAME = 'products';
      const CONFIG_STORE = 'config';

      const openDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result);

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // Create products store if it doesn't exist
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              const productStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
              productStore.createIndex('name', 'name', { unique: false });
              productStore.createIndex('category', 'category', { unique: false });
              productStore.createIndex('expiryDate', 'expiryDate', { unique: false });
            }
            
            // Create config store if it doesn't exist
            if (!db.objectStoreNames.contains(CONFIG_STORE)) {
              db.createObjectStore(CONFIG_STORE, { keyPath: 'key' });
            }
          };
        });
      };

      const getProducts = async () => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], 'readonly');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.getAll();

          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      };

      const saveProducts = async (products) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          
          // Clear existing data
          store.clear();
          
          // Add new data
          if (Array.isArray(products) && products.length > 0) {
            products.forEach(product => store.add(product));
          }

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
      };

      const getConfig = async (key) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CONFIG_STORE], 'readonly');
          const store = transaction.objectStore(CONFIG_STORE);
          const request = store.get(key);

          request.onsuccess = () => resolve(request.result ? request.result.value : null);
          request.onerror = () => reject(request.error);
        });
      };

      const saveConfig = async (key, value) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([CONFIG_STORE], 'readwrite');
          const store = transaction.objectStore(CONFIG_STORE);
          
          // Check if key exists
          const getRequest = store.get(key);
          
          getRequest.onsuccess = () => {
            if (getRequest.result) {
              // Update existing
              store.put({ key, value });
            } else {
              // Add new
              store.add({ key, value });
            }
          };

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
      };

      return { getProducts, saveProducts, getConfig, saveConfig };
    };

    // Componente principal
    const App = () => {
      const db = useIndexedDB();
      
      // Estado principal
      const [darkMode, setDarkMode] = useState(false);
      const [products, setProducts] = useState([]);
      const [showModal, setShowModal] = useState(false);
      const [editingProduct, setEditingProduct] = useState(null);
      const [activeTab, setActiveTab] = useState('farmacia');
      const [searchTerm, setSearchTerm] = useState('');
      const [filterCategory, setFilterCategory] = useState('');
      const [filterStatus, setFilterStatus] = useState('todos');
      const [alerts, setAlerts] = useState({});
      const [toast, setToast] = useState(null);
      const [showScanner, setShowScanner] = useState(false);
      const [barcodeResult, setBarcodeResult] = useState('');
      const [importModal, setImportModal] = useState(false);
      const [exportModal, setExportModal] = useState(false);
      const [isLoading, setIsLoading] = useState(true);

      const fileInputRef = useRef(null);
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const streamRef = useRef(null);

      // Categorías predefinidas
      const categories = {
        farmacia: [
          'Analgésicos', 'Antibióticos', 'Antiinflamatorios', 'Antihistamínicos', 'Antipiréticos',
          'Antidepresivos', 'Ansiolíticos', 'Antidiabéticos', 'Antihipertensivos', 'Estatinas',
          'Broncodilatadores', 'Corticosteroides', 'Diuréticos', 'Anticoagulantes', 'Antiácidos',
          'Laxantes', 'Suplementos vitamínicos', 'Insulina', 'Hormonas', 'Anticonceptivos',
          'Oftálmicos', 'Dermatológicos', 'Antisépticos', 'Antifúngicos', 'Antivirales'
        ],
        alimentos: [
          'Lácteos', 'Carnes', 'Pescados', 'Frutas', 'Verduras',
          'Cereales', 'Legumbres', 'Harinas', 'Aceites', 'Conservas',
          'Bebidas', 'Snacks', 'Postres', 'Condimentos', 'Especias',
          'Congelados', 'Embutidos', 'Panadería', 'Pasteles', 'Galletas',
          'Café', 'Té', 'Chocolate', 'Mermeladas', 'Salsas'
        ],
        otros: [
          'Cosméticos', 'Cremas', 'Maquillaje', 'Perfumes', 'Desodorantes',
          'Productos de limpieza', 'Detergentes', 'Jabones', 'Champús', 'Acondicionadores',
          'Productos para bebés', 'Pañales', 'Toallitas húmedas', 'Repelentes', 'Protectores solares',
          'Baterías', 'Pilas', 'Cartuchos de tinta', 'Productos químicos', 'Adhesivos',
          'Pinturas', 'Disolventes', 'Lubricantes', 'Combustibles', 'Gas'
        ]
      };

      // Alertas por defecto
      const defaultAlerts = {
        farmacia: 30,
        alimentos: 15,
        otros: 7
      };

      // Efecto para cargar datos del IndexedDB
      useEffect(() => {
        const loadData = async () => {
          try {
            // Cargar productos
            const savedProducts = await db.getProducts();
            if (savedProducts && Array.isArray(savedProducts)) {
              setProducts(savedProducts);
            }

            // Cargar modo oscuro
            const savedDarkMode = await db.getConfig('darkMode');
            if (savedDarkMode !== null) {
              setDarkMode(savedDarkMode === 'true');
            } else {
              // Detectar preferencia del sistema
              const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
              setDarkMode(systemPrefersDark);
            }

            // Cargar alertas
            const savedAlerts = await db.getConfig('alerts');
            if (savedAlerts) {
              setAlerts(savedAlerts);
            } else {
              setAlerts(defaultAlerts);
            }
          } catch (error) {
            console.error('Error loading data from IndexedDB:', error);
            // Usar valores por defecto en caso de error
            setProducts([]);
            setAlerts(defaultAlerts);
            setDarkMode(window.matchMedia('(prefers-color-scheme: dark)').matches);
          } finally {
            setIsLoading(false);
          }
        };

        loadData();
      }, []);

      // Efecto para guardar productos en IndexedDB
      useEffect(() => {
        if (isLoading) return;
        
        const saveData = async () => {
          try {
            await db.saveProducts(products);
          } catch (error) {
            console.error('Error saving products to IndexedDB:', error);
            showToast('Error al guardar los productos', 'error');
          }
        };

        saveData();
      }, [products, isLoading]);

      // Efecto para guardar configuración en IndexedDB
      useEffect(() => {
        if (isLoading) return;
        
        const saveConfig = async () => {
          try {
            await db.saveConfig('darkMode', darkMode.toString());
          } catch (error) {
            console.error('Error saving dark mode to IndexedDB:', error);
          }
        };

        saveConfig();
        
        // Aplicar modo oscuro al body
        if (darkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }, [darkMode, isLoading]);

      useEffect(() => {
        if (isLoading) return;
        
        const saveAlerts = async () => {
          try {
            await db.saveConfig('alerts', alerts);
          } catch (error) {
            console.error('Error saving alerts to IndexedDB:', error);
          }
        };

        saveAlerts();
      }, [alerts, isLoading]);

      // Función para obtener estado del producto
      const getProductStatus = (product) => {
        const today = new Date();
        const expiryDate = new Date(product.expiryDate);
        const timeDiff = expiryDate - today;
        const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

        const alertDays = alerts[product.categoryType] || 15;

        if (daysDiff < 0) return 'vencido';
        if (daysDiff <= alertDays) return 'porVencer';
        if (product.quantity <= 2) return 'porMermar';
        return 'bueno';
      };

      // Función para obtener icono de estado
      const getStatusIcon = (status) => {
        switch (status) {
          case 'bueno': return '✅';
          case 'porVencer': return '⚠️';
          case 'vencido': return '❌';
          case 'porMermar': return '⏳';
          default: return '✅';
        }
      };

      // Filtrar y buscar productos
      const filteredProducts = useMemo(() => {
        return products.filter(product => {
          // Filtro por pestaña activa
          if (product.categoryType !== activeTab) return false;
          
          // Filtro por búsqueda
          if (searchTerm && !product.name.toLowerCase().includes(searchTerm.toLowerCase())) return false;
          
          // Filtro por categoría específica
          if (filterCategory && product.category !== filterCategory) return false;
          
          // Filtro por estado
          if (filterStatus !== 'todos') {
            const status = getProductStatus(product);
            if (filterStatus === 'buenos' && status !== 'bueno') return false;
            if (filterStatus === 'porVencer' && status !== 'porVencer') return false;
            if (filterStatus === 'porMermar' && status !== 'porMermar') return false;
            if (filterStatus === 'vencidos' && status !== 'vencido') return false;
          }
          
          return true;
        });
      }, [products, activeTab, searchTerm, filterCategory, filterStatus]);

      // Estadísticas
      const stats = useMemo(() => {
        const total = filteredProducts.length;
        const bueno = filteredProducts.filter(p => getProductStatus(p) === 'bueno').length;
        const porVencer = filteredProducts.filter(p => getProductStatus(p) === 'porVencer').length;
        const vencido = filteredProducts.filter(p => getProductStatus(p) === 'vencido').length;
        const porMermar = filteredProducts.filter(p => getProductStatus(p) === 'porMermar').length;
        
        return { total, bueno, porVencer, vencido, porMermar };
      }, [filteredProducts]);

      // Mostrar toast
      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      // Manejar agregar/editar producto
      const handleSaveProduct = (productData) => {
        if (editingProduct) {
          setProducts(prev => prev.map(p => p.id === editingProduct.id ? { ...productData, id: editingProduct.id } : p));
          showToast('Producto actualizado correctamente', 'success');
        } else {
          const newProduct = { ...productData, id: Date.now() };
          setProducts(prev => [...prev, newProduct]);
          showToast('Producto agregado correctamente', 'success');
        }
        setShowModal(false);
        setEditingProduct(null);
      };

      // Manejar eliminación
      const handleDeleteProduct = (id) => {
        if (window.confirm('¿Estás seguro de que deseas eliminar este producto?')) {
          setProducts(prev => prev.filter(p => p.id !== id));
          showToast('Producto eliminado', 'info');
        }
      };

      // Manejar importación CSV
      const handleImportCSV = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim());
            const imported = [];
            let errors = 0;

            for (let i = 1; i < lines.length; i++) { // Saltar encabezado
              const cols = lines[i].split(',').map(col => col.trim().replace(/^"(.*)"$/, '$1'));
              if (cols.length >= 5) {
                const [name, category, quantity, expiryDate, barcode] = cols;
                if (name && category && quantity && expiryDate) {
                  imported.push({
                    id: Date.now() + i,
                    name,
                    category,
                    quantity: parseInt(quantity) || 1,
                    expiryDate,
                    barcode: barcode || '',
                    categoryType: 'alimentos', // Default
                    image: ''
                  });
                } else {
                  errors++;
                }
              } else {
                errors++;
              }
            }

            setProducts(prev => [...prev, ...imported]);
            showToast(`Importación completada: ${imported.length} productos agregados, ${errors} errores`, 'success');
            setImportModal(false);
          } catch (error) {
            showToast('Error al procesar el archivo CSV', 'error');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      // Manejar exportación CSV
      const handleExportCSV = () => {
        const headers = ['Nombre', 'Categoría', 'Cantidad', 'Fecha', 'Código'];
        const csvContent = [
          headers.join(','),
          ...products.map(p => [
            `"${p.name}"`,
            `"${p.category}"`,
            p.quantity,
            p.expiryDate,
            `"${p.barcode || ''}"`
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `productos_caducidad_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Productos exportados a CSV', 'success');
        setExportModal(false);
      };

      // Generar PDF
      const generatePDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.text('Reporte de Control de Caducidades', 14, 20);
        doc.setFontSize(12);
        doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, 30);
        doc.text(`Total de productos: ${products.length}`, 14, 40);

        // Tabla de productos
        const tableData = products.map(p => [
          p.name,
          p.category,
          p.quantity.toString(),
          p.expiryDate,
          getProductStatus(p)
        ]);

        doc.autoTable({
          head: [['Nombre', 'Categoría', 'Cantidad', 'Fecha', 'Estado']],
          body: tableData,
          startY: 50
        });

        doc.save(`reporte_caducidad_${new Date().toISOString().split('T')[0]}.pdf`);
        showToast('Reporte PDF generado', 'success');
      };

      // Iniciar escaneo de código de barras
      const startScanner = () => {
        setShowScanner(true);
        setTimeout(() => {
          if (Quagga) {
            Quagga.init({
              inputStream: {
                name: "Live",
                type: "LiveStream",
                target: videoRef.current,
                constraints: {
                  width: 640,
                  height: 480,
                  facingMode: "environment"
                },
              },
              decoder: {
                readers: [
                  "code_128_reader",
                  "ean_reader",
                  "ean_8_reader",
                  "code_39_reader",
                  "code_39_vin_reader",
                  "codabar_reader",
                  "upc_reader",
                  "upc_e_reader",
                  "i2of5_reader"
                ]
              }
            }, function(err) {
              if (err) {
                console.error(err);
                showToast('Error al iniciar la cámara', 'error');
                setShowScanner(false);
                return;
              }
              Quagga.start();
              Quagga.onDetected((data) => {
                setBarcodeResult(data.codeResult.code);
                Quagga.stop();
                setShowScanner(false);
              });
            });
          }
        }, 500);
      };

      // Detener escaneo
      const stopScanner = () => {
        if (Quagga) {
          Quagga.stop();
        }
        setShowScanner(false);
      };

      // Componente de producto
      const ProductCard = ({ product }) => {
        const status = getProductStatus(product);
        const statusColor = {
          bueno: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
          porVencer: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
          vencido: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
          porMermar: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
        };

        return (
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-3 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-200">
            <div className="flex justify-between items-start mb-2">
              <h3 className="font-semibold text-lg">{product.name}</h3>
              <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColor[status]}`}>
                {getStatusIcon(status)} {status === 'bueno' ? 'Bueno' : status === 'porVencer' ? 'Por vencer' : status === 'vencido' ? 'Vencido' : 'Por mermar'}
              </span>
            </div>
            
            <div className="grid grid-cols-2 gap-2 text-sm mb-3">
              <div><span className="font-medium">Categoría:</span> {product.category}</div>
              <div><span className="font-medium">Cantidad:</span> {product.quantity}</div>
              <div><span className="font-medium">Fecha:</span> {product.expiryDate}</div>
              <div><span className="font-medium">Código:</span> {product.barcode || 'N/A'}</div>
            </div>

            {product.image && (
              <img src={product.image} alt={product.name} className="w-full h-32 object-cover rounded mb-3" />
            )}

            <div className="flex justify-end space-x-2">
              <button 
                onClick={() => { setEditingProduct(product); setShowModal(true); }}
                className="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm"
              >
                <i className="fas fa-edit mr-1"></i>Editar
              </button>
              <button 
                onClick={() => handleDeleteProduct(product.id)}
                className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-sm"
              >
                <i className="fas fa-trash mr-1"></i>Eliminar
              </button>
            </div>
          </div>
        );
      };

      // Componente de modal
      const Modal = ({ children, onClose }) => (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-screen overflow-y-auto scrollbar-custom">
            <div className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
              <h2 className="text-xl font-semibold">Agregar Producto</h2>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i className="fas fa-times"></i>
              </button>
            </div>
            <div className="p-4">
              {children}
            </div>
          </div>
        </div>
      );

      // Componente de formulario
      const ProductForm = ({ initialData = null, onSave, onCancel }) => {
        const [formData, setFormData] = useState({
          name: initialData?.name || '',
          category: initialData?.category || categories[activeTab][0],
          quantity: initialData?.quantity || 1,
          expiryDate: initialData?.expiryDate || '',
          barcode: initialData?.barcode || '',
          image: initialData?.image || ''
        });
        const [errors, setErrors] = useState({});
        const fileInputRef = useRef(null);

        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData(prev => ({ ...prev, [name]: value }));
          if (errors[name]) {
            setErrors(prev => ({ ...prev, [name]: '' }));
          }
        };

        const handleImageChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              setFormData(prev => ({ ...prev, image: e.target.result }));
            };
            reader.readAsDataURL(file);
          }
        };

        const validate = () => {
          const newErrors = {};
          if (!formData.name.trim()) newErrors.name = 'El nombre es requerido';
          if (!formData.expiryDate) newErrors.expiryDate = 'La fecha de vencimiento es requerida';
          setErrors(newErrors);
          return Object.keys(newErrors).length === 0;
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          if (validate()) {
            onSave({ ...formData, categoryType: activeTab });
          }
        };

        return (
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1">Nombre *</label>
              <input
                type="text"
                name="name"
                value={formData.name}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
                placeholder="Nombre del producto"
              />
              {errors.name && <p className="text-red-500 text-xs mt-1">{errors.name}</p>}
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Categoría</label>
              <select
                name="category"
                value={formData.category}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
              >
                {categories[activeTab].map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Cantidad</label>
              <input
                type="number"
                name="quantity"
                value={formData.quantity}
                onChange={handleChange}
                min="1"
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Fecha de vencimiento *</label>
              <input
                type="date"
                name="expiryDate"
                value={formData.expiryDate}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
              />
              {errors.expiryDate && <p className="text-red-500 text-xs mt-1">{errors.expiryDate}</p>}
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Código de barras</label>
              <div className="flex">
                <input
                  type="text"
                  name="barcode"
                  value={formData.barcode}
                  onChange={handleChange}
                  className="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
                  placeholder="Código de barras"
                />
                <button
                  type="button"
                  onClick={startScanner}
                  className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-r-md transition-colors duration-200"
                >
                  <i className="fas fa-barcode"></i>
                </button>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Foto</label>
              <input
                type="file"
                ref={fileInputRef}
                onChange={handleImageChange}
                accept="image/*"
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
              />
              {formData.image && (
                <div className="mt-2">
                  <img src={formData.image} alt="Preview" className="h-20 object-cover rounded" />
                </div>
              )}
            </div>

            <div className="flex space-x-3 pt-4">
              <button
                type="submit"
                className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors duration-200"
              >
                {initialData ? 'Actualizar' : 'Agregar'}
              </button>
              <button
                type="button"
                onClick={onCancel}
                className="flex-1 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white py-2 px-4 rounded-md transition-colors duration-200"
              >
                Cancelar
              </button>
            </div>
          </form>
        );
      };

      if (isLoading) {
        return (
          <div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600 dark:text-gray-400">Cargando datos...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
          {/* Header */}
          <header className="bg-white dark:bg-gray-800 shadow-sm">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center py-4">
                <div className="flex items-center">
                  <i className="fas fa-calendar-check text-blue-600 dark:text-blue-400 text-2xl mr-2"></i>
                  <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Control de Caducidades</h1>
                </div>
                <div className="flex items-center space-x-4">
                  <button
                    onClick={() => setDarkMode(!darkMode)}
                    className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200"
                  >
                    {darkMode ? <i className="fas fa-sun"></i> : <i className="fas fa-moon"></i>}
                  </button>
                  <div className="relative">
                    <button
                      onClick={() => setExportModal(true)}
                      className="p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200"
                    >
                      <i className="fas fa-cog"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            {/* Tabs */}
            <div className="mb-6 border-b border-gray-200 dark:border-gray-700">
              <nav className="flex space-x-8">
                {Object.keys(categories).map(tab => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`py-2 px-1 border-b-2 font-medium text-sm capitalize transition-colors duration-200 ${
                      activeTab === tab
                        ? 'border-blue-500 text-blue-600 dark:text-blue-400'
                        : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300'
                    }`}
                  >
                    {tab}
                  </button>
                ))}
              </nav>
            </div>

            {/* Filtros y búsqueda */}
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Buscar</label>
                  <input
                    type="text"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    placeholder="Buscar productos..."
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Categoría</label>
                  <select
                    value={filterCategory}
                    onChange={(e) => setFilterCategory(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
                  >
                    <option value="">Todas las categorías</option>
                    {categories[activeTab].map(cat => (
                      <option key={cat} value={cat}>{cat}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Estado</label>
                  <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
                  >
                    <option value="todos">Todos</option>
                    <option value="buenos">Buenos</option>
                    <option value="porVencer">Por vencer</option>
                    <option value="porMermar">Próximos a mermar</option>
                    <option value="vencidos">Vencidos</option>
                  </select>
                </div>
                <div className="flex items-end">
                  <button
                    onClick={() => setShowModal(true)}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center"
                  >
                    <i className="fas fa-plus mr-2"></i> Agregar
                  </button>
                </div>
              </div>
            </div>

            {/* Estadísticas */}
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
                <div className="text-2xl font-bold text-blue-600 dark:text-blue-400">{stats.total}</div>
                <div className="text-sm text-gray-600 dark:text-gray-400">Total</div>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
                <div className="text-2xl font-bold text-green-600 dark:text-green-400">{stats.bueno}</div>
                <div className="text-sm text-gray-600 dark:text-gray-400">Buenos</div>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
                <div className="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{stats.porVencer}</div>
                <div className="text-sm text-gray-600 dark:text-gray-400">Por vencer</div>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
                <div className="text-2xl font-bold text-blue-600 dark:text-blue-400">{stats.porMermar}</div>
                <div className="text-sm text-gray-600 dark:text-gray-400">Por mermar</div>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
                <div className="text-2xl font-bold text-red-600 dark:text-red-400">{stats.vencido}</div>
                <div className="text-sm text-gray-600 dark:text-gray-400">Vencidos</div>
              </div>
            </div>

            {/* Lista de productos */}
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow min-h-96">
              {filteredProducts.length === 0 ? (
                <div className="p-8 text-center text-gray-500 dark:text-gray-400">
                  <i className="fas fa-box-open text-4xl mb-2 opacity-50"></i>
                  <p>No hay productos que coincidan con los filtros.</p>
                  <button
                    onClick={() => setShowModal(true)}
                    className="mt-4 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
                  >
                    Agregar un producto
                  </button>
                </div>
              ) : (
                <div className="p-4 max-h-96 overflow-y-auto scrollbar-custom">
                  {filteredProducts.map(product => (
                    <ProductCard key={product.id} product={product} />
                  ))}
                </div>
              )}
            </div>
          </main>

          {/* Botón flotante */}
          <button
            onClick={() => setShowModal(true)}
            className="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-colors duration-200 z-40"
          >
            <i className="fas fa-plus text-xl"></i>
          </button>

          {/* Modal de producto */}
          {showModal && (
            <Modal onClose={() => { setShowModal(false); setEditingProduct(null); }}>
              <ProductForm
                initialData={editingProduct}
                onSave={handleSaveProduct}
                onCancel={() => { setShowModal(false); setEditingProduct(null); }}
              />
            </Modal>
          )}

          {/* Modal de escáner */}
          {showScanner && (
            <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50">
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
                <div className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                  <h2 className="text-xl font-semibold">Escanear Código de Barras</h2>
                  <button onClick={stopScanner} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i className="fas fa-times"></i>
                  </button>
                </div>
                <div className="p-4">
                  <video ref={videoRef} className="w-full rounded" autoPlay playsInline></video>
                  {barcodeResult && (
                    <div className="mt-4 p-3 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">
                      Código detectado: <strong>{barcodeResult}</strong>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Modal de exportación/importación */}
          {exportModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
                <div className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                  <h2 className="text-xl font-semibold">Configuración</h2>
                  <button onClick={() => setExportModal(false)} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i className="fas fa-times"></i>
                  </button>
                </div>
                <div className="p-4 space-y-4">
                  <button
                    onClick={handleExportCSV}
                    className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center"
                  >
                    <i className="fas fa-file-csv mr-2"></i> Exportar a CSV
                  </button>
                  <button
                    onClick={() => setImportModal(true)}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center"
                  >
                    <i className="fas fa-file-import mr-2"></i> Importar desde CSV
                  </button>
                  <button
                    onClick={generatePDF}
                    className="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center"
                  >
                    <i className="fas fa-file-pdf mr-2"></i> Generar PDF
                  </button>
                  
                  <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h3 className="font-medium mb-2">Alertas por categoría (días antes)</h3>
                    {Object.keys(alerts).map(cat => (
                      <div key={cat} className="flex items-center justify-between mb-2">
                        <span className="capitalize">{cat}</span>
                        <input
                          type="number"
                          value={alerts[cat]}
                          onChange={(e) => setAlerts(prev => ({ ...prev, [cat]: parseInt(e.target.value) || 1 }))}
                          className="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm"
                          min="1"
                        />
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Modal de importación */}
          {importModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
                <div className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                  <h2 className="text-xl font-semibold">Importar desde CSV</h2>
                  <button onClick={() => setImportModal(false)} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i className="fas fa-times"></i>
                  </button>
                </div>
                <div className="p-4">
                  <p className="mb-4 text-sm text-gray-600 dark:text-gray-400">
                    El archivo CSV debe tener las columnas: Nombre, Categoría, Cantidad, Fecha, Código
                  </p>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleImportCSV}
                    ref={fileInputRef}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"
                  />
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors duration-200"
                  >
                    Seleccionar archivo
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Toast notifications */}
          {toast && (
            <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white flex items-center space-x-2 toast ${
              toast.type === 'success' ? 'bg-green-600' :
              toast.type === 'error' ? 'bg-red-600' :
              'bg-blue-600'
            }`}>
              <i className={`fas ${toast.type === 'success' ? 'fa-check' : toast.type === 'error' ? 'fa-times' : 'fa-info'}`}></i>
              <span>{toast.message}</span>
            </div>
          )}
        </div>
      );
    };

    // Renderizar la app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
